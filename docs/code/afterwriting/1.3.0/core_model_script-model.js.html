<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/model/script-model.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="View.AppView.html">AppView</a></li></ul><h3>Modules</h3><ul><li><a href="module-bootstrap_app-config.html">bootstrap/app-config</a></li><li><a href="module-bootstrap_core-config.html">bootstrap/core-config</a><ul class='methods'><li data-type='method'><a href="module-bootstrap_core-config.html#~init">init</a></li></ul></li><li><a href="module-bootstrap_dev-config.html">bootstrap/dev-config</a></li><li><a href="module-client_client-config.html">client/client-config</a></li><li><a href="module-core_plugin.html">core/plugin</a></li><li><a href="module-plugin_info_info-plugin.html">plugin/info/info-plugin</a></li><li><a href="module-plugin_info_model_info-section.html">plugin/info/model/info-section</a></li><li><a href="module-theme_aw-bubble_model_section.html">theme/aw-bubble/model/section</a></li><li><a href="module-utils_browser.html">utils/browser</a><ul class='methods'><li data-type='method'><a href="module-utils_browser.html#.url_params">url_params</a></li></ul></li><li><a href="module-utils_fn.html">utils/fn</a><ul class='methods'><li data-type='method'><a href="module-utils_fn.html#.conflate">conflate</a></li></ul></li><li><a href="module-utils_helper.html">utils/helper</a><ul class='methods'><li data-type='method'><a href="module-utils_helper.html#.blank_text">blank_text</a></li><li data-type='method'><a href="module-utils_helper.html#.format_time">format_time</a></li><li data-type='method'><a href="module-utils_helper.html#.get_indentation">get_indentation</a></li></ul></li></ul><h3>Mixins</h3><ul><li><a href="theme_aw-bubble_view_section-view-mixin.html">theme/aw-bubble/view/section-view-mixin</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-bootstrap.html">bootstrap</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_basicStats">_basicStats</a></li><li><a href="global.html#_fileSaved">_fileSaved</a></li><li><a href="global.html#_loadSettings">_loadSettings</a></li><li><a href="global.html#_saveToCloud">_saveToCloud</a></li><li><a href="global.html#_scriptChanged">_scriptChanged</a></li><li><a href="global.html#activate">activate</a></li><li><a href="global.html#BaseSectionPresenter">BaseSectionPresenter</a></li><li><a href="global.html#control">control</a></li><li><a href="global.html#date">date</a></li><li><a href="global.html#deactivate">deactivate</a></li><li><a href="global.html#getLastVisitDate">getLastVisitDate</a></li><li><a href="global.html#getSettingGroups">getSettingGroups</a></li><li><a href="global.html#getTdWrapper">getTdWrapper</a></li><li><a href="global.html#goto">goto</a></li><li><a href="global.html#group">group</a></li><li><a href="global.html#groups">groups</a></li><li><a href="global.html#hide">hide</a></li><li><a href="global.html#lastUsedInfo">lastUsedInfo</a></li><li><a href="global.html#LastUsedInfo">LastUsedInfo</a></li><li><a href="global.html#lastUsedInfoLoaded">lastUsedInfoLoaded</a></li><li><a href="global.html#require">require</a></li><li><a href="global.html#resolve_module_name">resolve_module_name</a></li><li><a href="global.html#script">script</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#title">title</a></li><li><a href="global.html#updateSize">updateSize</a></li><li><a href="global.html#view">view</a></li><li><a href="global.html#withNewFontSize">withNewFontSize</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">core/model/script-model.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define(function(require) {

    var Protoplast = require('protoplast'),
        fquery = require('utils/fountain/query'),
        fhelpers = require('utils/fountain/helpers'),
        fparser = require('aw-parser').parser,
        fliner = require('utils/fountain/liner'),
        converter = require('utils/converters/scriptconverter'),
        preprocessor = require('utils/fountain/preprocessor');

    var h = fhelpers.fq;

    var ScriptModel = Protoplast.Model.extend({

        settings: {
            inject: 'settings'
        },

        /**
         * Basic stats query
         */
        _basicStats: null,

        format: null,

        parsed: {
            computed: ['script'],
            lazy: true,
            value: function() {
                var parsed;

                parsed = fparser.parse(this.script, {
                    print_headers: this.settings.print_headers,
                    print_actions: this.settings.print_actions,
                    print_dialogues: this.settings.print_dialogues,
                    print_notes: this.settings.print_notes,
                    print_sections: this.settings.print_sections,
                    print_synopsis: this.settings.print_synopsis,
                    each_scene_on_new_page: this.settings.each_scene_on_new_page,
                    double_space_between_scenes: this.settings.double_space_between_scenes,
                    use_dual_dialogue: this.settings.use_dual_dialogue
                });

                parsed.lines = fliner.line(parsed.tokens, {
                    print: this.settings.print,
                    text_more: this.settings.text_more,
                    text_contd: this.settings.text_contd,
                    split_dialogue: this.settings.split_dialogue
                });
                
                return parsed;
            }
        },

        parsed_stats: {
            computed: ['parsed'],
            lazy: true,
            value: function() {
                var parsed_stats;

                if (this.settings.use_print_settings_for_stats) {
                    parsed_stats = this.parsed;
                } else {
                    var stats_config = Object.create(this.settings);
                    stats_config.print_actions = true;
                    stats_config.print_headers = true;
                    stats_config.print_dialogues = true;
                    stats_config.print_sections = false;
                    stats_config.print_notes = false;
                    stats_config.print_synopsis = false;
                    parsed_stats = fparser.parse(this.script, stats_config);
                    parsed_stats.lines = fliner.line(parsed_stats.tokens, stats_config);
                }

                return parsed_stats;
            }
        },

        script: {
            set: function(value) {
                var result = converter.to_fountain(value);
                result.value = preprocessor.process_snippets(result.value, this.settings.snippets);
                this.format = this.format || result.format;
                this._script = result.value;
                this.dispatch('script_changed');
            },
            get: function() {
                return this._script;
            }
        },

        getBasicStats: function() {
            this._createStatsQuery(); // to refresh config-related properties
            return this._basicStats.run(this.parsed_stats.lines);
        },

        _createStatsQuery: function() {
            var print = this.settings.print;
            var basic = fquery(null, {
                last_page_lines: 0,
                scenes: 0,
                pages: 0,
                filled_pages: 0,
                action_lines: 0,
                dialogue_lines: 0,
                action_scenes: 0,
                dialogue_scenes: 0
            });
            basic.prepare(function(fq) {
                fq.current_scene_heading_token = null;
                fq.dialogue_in_the_scene = false;
            });
            basic.count('action_lines', h.is('action', 'scene_heading', 'shot'));
            basic.count('dialogue_lines', h.is_dialogue());
            basic.count('pages', h.is('page_break'));
            basic.enter(h.is_dialogue(), function(item, fq) {
                fq.dialogue_in_the_scene = true;
            });
            basic.enter(h.is('scene_heading'), function(item, fq) {
                if (fq.current_scene_heading_token !== item.token) {
                    fq.select().scenes++;
                    fq.current_scene_heading_token = item.token;
                    if (fq.select().scenes > 1) {
                        if (fq.dialogue_in_the_scene) {
                            fq.select().dialogue_scenes += 1;
                        } else {
                            fq.select().action_scenes += 1;
                        }
                        fq.dialogue_in_the_scene = false;
                    }
                }
            });
            basic.enter(true, function(item, fq) {
                var selector = fq.select();
                if (item.is('page_break')) {
                    selector.filled_pages += (selector.last_page_lines + 1) / print.lines_per_page;
                    selector.last_page_lines = 0;
                } else {
                    selector.last_page_lines++;
                }
            });
            basic.exit(function(item, fq) {
                // last scene
                if (fq.dialogue_in_the_scene) {
                    fq.select().dialogue_scenes++;
                } else {
                    fq.select().action_scenes++;
                }

                var all = item.action_lines + item.dialogue_lines;
                item.pages = item.pages + item.last_page_lines / print.lines_per_page;
                item.filled_pages += item.last_page_lines / print.lines_per_page;
                item.action_time = (item.action_lines / all) * item.filled_pages;
                item.dialogue_time = (item.dialogue_lines / all) * item.filled_pages;
            });
            basic.end(function(result) {
                if (result.length === 0) {
                    result.push({
                        pages: 0.0,
                        filled_pages: 0.0,
                        scenes: 0,
                        action_time: 0.0,
                        dialogue_time: 0.0,
                        dialogue_lines: 0,
                        characters: [],
                        locations: []
                    });
                }
            });

            this._basicStats = basic;
        }

    });

    return ScriptModel;
});</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta2</a> on Sun Mar 05 2017 19:40:18 GMT+0000 (GMT (czas standardowy)) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
